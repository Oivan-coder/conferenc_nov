<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Регистрация - LAB Evolution 2024</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="registration-page">
    <header>
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <div class="logo-icon">⚕️</div>
                    <div>LAB Evolution 2024</div>
                </a>
                <nav>
                    <ul>
                        <li><a href="index.html#about">О событии</a></li>
                        <li><a href="index.html#program">Программа</a></li>
                        <li><a href="index.html#speakers">Эксперты</a></li>
                        <li><a href="index.html#partners">Технологии</a></li>
                        <li><a href="index.html#registration">Участие</a></li>
                        <li><a href="index.html#contacts">Контакты</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="registration-container">
        <div class="logo-section">
            <div class="logo-icon">⚕️</div>
            <h1>LAB Evolution 2024</h1>
        </div>
        
        <h2>Регистрация на конференцию</h2>
        <p class="subtitle">Заполните форму для участия в мероприятии</p>
        
        <form id="visible-form" class="registration-form-single">
            <div class="form-group">
                <label for="email">Электронная почта *</label>
                <input type="email" id="email" name="email" placeholder="example@mail.ru" required>
            </div>

            <div class="form-group">
                <label for="name">ФИО *</label>
                <input type="text" id="name" name="name" placeholder="Введите ваше полное имя" required>
            </div>
            
            <div class="form-group">
                <label for="position">Должность *</label>
                <select id="position" name="position" required>
                    <option value="">-- Выберите должность --</option>
                    <option value="Главный врач">Главный врач</option>
                    <option value="Гость">Гость</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="organization">Организация *</label>
                <input type="text" id="organization" name="organization" placeholder="Название медицинского учреждения" required>
            </div>
            
            <div class="form-group">
                <label for="phone">Телефон *</label>
                <input type="tel" id="phone" name="phone" placeholder="+7 (XXX) XXX-XX-XX" required>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="agreement" required>
                <label for="agreement">
                    Даю согласие на обработку персональных данных
                </label>
            </div>
            
            <button type="submit" class="submit-btn">Зарегистрироваться</button>
        </form>

        <div id="success-message" class="success-message" style="display: none;">
            <div class="success-icon">✅</div>
            <h3>Спасибо за регистрацию!</h3>
            <p>На ваш email отправлено подтверждение.</p>
            <a href="index.html" class="back-home-btn">Вернуться на главную</a>
        </div>

        <div class="back-link">
            <a href="index.html">← Вернуться на главную страницу</a>
        </div>
    </div>

    <script>
// Храним локальные дубли (на случай быстрых повторных отправок)
const submittedData = new Set();

document.getElementById('visible-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!document.getElementById('agreement').checked) {
        showError('Необходимо дать согласие на обработку персональных данных');
        return;
    }
    
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;
    
    // Быстрая локальная проверка
    if (submittedData.has(email + phone)) {
        showError('Вы уже отправляли эту форму');
        return;
    }
    
    // Блокируем кнопку
    const submitBtn = this.querySelector('.submit-btn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Проверяем...';
    submitBtn.disabled = true;
    
    try {
        // Проверяем дубли на сервере
        const isDup = await checkDuplicate(email, phone);
        if (isDup) {
            showError('Регистрация с таким email или телефоном уже выполнена');
            resetButton(submitBtn, originalText);
            return;
        }
        
        // Отправляем в Google Forms
        const success = await submitToGoogleForms();
        if (success) {
            submittedData.add(email + phone);
            showSuccess();
        } else {
            showError('Ошибка отправки. Попробуйте еще раз.');
            resetButton(submitBtn, originalText);
        }
    } catch (error) {
        console.error('Ошибка:', error);
        showError('Ошибка сети. Проверьте соединение.');
        resetButton(submitBtn, originalText);
    }
});

// Функция проверки дублей через Apps Script
async function checkDuplicate(email, phone) {
    const response = await fetch('ВАШ_URL_APPS_SCRIPT', {
        method: 'POST',
        body: JSON.stringify({ email, phone })
    });
    const result = await response.json();
    return result.isDuplicate;
}

// Остальной код остается как был...
async function submitToGoogleForms() {
    return new Promise((resolve) => {
        // Ваш существующий код отправки в Google Forms
        const iframe = document.createElement('iframe');
        iframe.name = 'google-form-target-' + Date.now();
        iframe.style.display = 'none';
        
        iframe.onload = () => {
            console.log('Форма успешно отправлена в Google Forms');
            resolve(true);
            setTimeout(() => {
                if (iframe.parentNode) iframe.parentNode.removeChild(iframe);
            }, 5000);
        };
        
        document.body.appendChild(iframe);
        
        const tempForm = document.createElement('form');
        tempForm.action = 'https://docs.google.com/forms/u/0/d/e/1FAIpQLSc7urE88w0Y_zM7EBGbhQN8Uw87Uw6eFRBm2d9GvqJT7Q4S0A/formResponse';
        tempForm.method = 'POST';
        tempForm.target = iframe.name;
        tempForm.style.display = 'none';
        
        const fields = [
            { name: 'entry.1277724311', value: document.getElementById('email').value },
            { name: 'entry.74922399', value: document.getElementById('name').value },
            { name: 'entry.827511450', value: document.getElementById('position').value },
            { name: 'entry.1066367767', value: document.getElementById('organization').value },
            { name: 'entry.362036752', value: document.getElementById('phone').value }
        ];
        
        fields.forEach(field => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = field.name;
            input.value = field.value;
            tempForm.appendChild(input);
        });
        
        document.body.appendChild(tempForm);
        tempForm.submit();
        
        setTimeout(() => {
            if (tempForm.parentNode) tempForm.parentNode.removeChild(tempForm);
            resolve(true);
        }, 8000);
    });
}
</script>
</body>
</html>
