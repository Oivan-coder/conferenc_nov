<script>
// Храним отправленные данные для проверки дублей
const submittedData = new Set();

document.getElementById('visible-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!document.getElementById('agreement').checked) {
        showError('Необходимо дать согласие на обработку персональных данных');
        return;
    }
    
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;
    
    // Проверка дублей
    if (isDuplicate(email, phone)) {
        showError('Регистрация с таким email или телефоном уже выполнена');
        return;
    }
    
    // Блокируем кнопку
    const submitBtn = this.querySelector('.submit-btn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Отправляем...';
    submitBtn.disabled = true;
    
    try {
        // Пытаемся отправить данные
        const success = await submitToGoogleForms();
        
        if (success) {
            // Добавляем в множество отправленных
            submittedData.add(email + phone);
            showSuccess();
        } else {
            showError('Ошибка отправки. Попробуйте еще раз');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    } catch (error) {
        showError('Ошибка сети. Проверьте соединение');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

// Проверка дублей
function isDuplicate(email, phone) {
    const key = email + phone;
    return submittedData.has(key);
}

// Отправка в Google Forms с подтверждением
async function submitToGoogleForms() {
    return new Promise((resolve) => {
        // Создаем iframe для отслеживания загрузки
        const iframe = document.createElement('iframe');
        iframe.name = 'google-form-target-' + Date.now();
        iframe.style.display = 'none';
        
        // Обработчик загрузки iframe
        iframe.onload = function() {
            console.log('Форма отправлена успешно');
            resolve(true);
            
            // Чистим через время
            setTimeout(() => {
                if (document.body.contains(iframe)) {
                    document.body.removeChild(iframe);
                }
            }, 5000);
        };
        
        iframe.onerror = function() {
            console.log('Ошибка отправки формы');
            resolve(false);
        };
        
        document.body.appendChild(iframe);
        
        // Создаем временную форму
        const tempForm = document.createElement('form');
        tempForm.action = 'https://docs.google.com/forms/d/e/1bs8gMkiMStZgHipFuQPMCqInuS1Z0N2SbjaprMeGKTk/formResponse';
        tempForm.method = 'POST';
        tempForm.target = iframe.name;
        tempForm.style.display = 'none';
        
        // Добавляем поля
        const fields = [
            { name: 'entry.200207254', value: document.getElementById('email').value },
            { name: 'entry.74922399', value: document.getElementById('name').value },
            { name: 'entry.827511450', value: document.getElementById('position').value },
            { name: 'entry.1066367767', value: document.getElementById('organization').value },
            { name: 'entry.362036752', value: document.getElementById('phone').value }
        ];
        
        fields.forEach(field => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = field.name;
            input.value = field.value;
            tempForm.appendChild(input);
        });
        
        document.body.appendChild(tempForm);
        tempForm.submit();
        
        // Таймаут на случай если iframe не загрузится
        setTimeout(() => {
            if (document.body.contains(tempForm)) {
                document.body.removeChild(tempForm);
            }
            resolve(true); // Считаем успехом даже без подтверждения
        }, 10000);
    });
}

// Показ ошибки
function showError(message) {
    // Создаем или находим блок ошибки
    let errorDiv = document.getElementById('error-message');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'error-message';
        errorDiv.style.cssText = `
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #ffcdd2;
        `;
        document.querySelector('.registration-form-single').prepend(errorDiv);
    }
    
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    
    // Автоскрытие через 5 секунд
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

// Показ успеха
function showSuccess() {
    document.getElementById('visible-form').style.display = 'none';
    document.getElementById('success-message').style.display = 'block';
}

// Валидация email и телефона в реальном времени
document.getElementById('email').addEventListener('blur', validateEmail);
document.getElementById('phone').addEventListener('blur', validatePhone);

function validateEmail() {
    const email = this.value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (email && !emailRegex.test(email)) {
        this.style.borderColor = '#c62828';
        showError('Введите корректный email адрес');
    } else {
        this.style.borderColor = '#e0e0e0';
    }
}

function validatePhone() {
    const phone = this.value;
    const phoneRegex = /^\+7\s?\(?\d{3}\)?\s?\d{3}[\s-]?\d{2}[\s-]?\d{2}$/;
    
    if (phone && !phoneRegex.test(phone.replace(/\s/g, ''))) {
        this.style.borderColor = '#c62828';
        showError('Введите телефон в формате: +7 (XXX) XXX-XX-XX');
    } else {
        this.style.borderColor = '#e0e0e0';
    }
}
</script>
